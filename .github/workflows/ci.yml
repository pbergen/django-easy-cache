name: CI/CD

on:
  push:
    branches:
    - main
    tags:
      - '*.*.*'           # Release tags: 1.0.0
      - '*.*.*a*'         # Alpha tags: 1.0.0a1
      - '*.*.*b*'         # Beta tags: 1.0.0b1
      - '*.*.*rc*'        # Release candidate: 1.0.0rc1
  pull_request:

jobs:
  linting:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install required packages
        run: pip install pre-commit packaging

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

      - name: Validate PEP 440 version format
        run: |
          python -c "
          import tomllib
          import re
          from packaging.version import Version

          # Check pyproject.toml version
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)

          pyproject_version = data['project']['version']
          print(f'Validating pyproject.toml version: {pyproject_version}')

          try:
              Version(pyproject_version)
              print('✅ pyproject.toml version is PEP 440 compliant')
          except Exception as e:
              print(f'❌ pyproject.toml version is NOT PEP 440 compliant: {e}')
              exit(1)

          # Check __init__.py version
          with open('easy_cache/__init__.py', 'r') as f:
              init_content = f.read()

          version_match = re.search(r'__version__ = [\"\'](.*?)[\"\']', init_content)
          if not version_match:
              print('❌ No __version__ found in easy_cache/__init__.py')
              exit(1)

          init_version = version_match.group(1)
          print(f'Validating __init__.py version: {init_version}')

          try:
              Version(init_version)
              print('✅ __init__.py version is PEP 440 compliant')
          except Exception as e:
              print(f'❌ __init__.py version is NOT PEP 440 compliant: {e}')
              exit(1)

          # Check versions match
          if pyproject_version != init_version:
              print(f'❌ Version mismatch: pyproject.toml has {pyproject_version}, __init__.py has {init_version}')
              exit(1)

          print('✅ All versions match and are PEP 440 compliant')
          "

  validate_migrations:
    name: Validate migrations
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: python -m pip install -U pip-tools && pip-compile --extra dev, -o requirements.txt pyproject.toml --resolver=backtracking && pip-sync

      - name: Validate migration integrity
        run: python manage.py makemigrations --check --dry-run

  tests:
    name: Python ${{ matrix.python-version }}, django ${{ matrix.django-version }}
    runs-on: ubuntu-24.04

    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13', ]
        django-version: ['42', '51', '52', ]

        exclude:
          - python-version: '3.9'
            django-version: 52
          - python-version: '3.9'
            django-version: 51
          - python-version: "3.13"
            django-version: 42

    steps:
      - uses: actions/checkout@v4
      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install tox
        run: pip install tox
      - name: Run Tests
        env:
          TOXENV: django${{ matrix.django-version }}
          DATABASE_URL: sqlite:///test_py${{ matrix.python-version }}_dj${{ matrix.django-version }}.db
        run: tox
      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-${{ matrix.python-version }}-${{ matrix.django-version }}
          path: '${{ github.workspace }}/.coverage.*'
          include-hidden-files: true
          if-no-files-found: error

  coverage:
    name: Coverage
    runs-on: ubuntu-24.04
    needs: tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: python -m pip install --upgrade coverage[toml]

      - name: Download data
        uses: actions/download-artifact@v4
        with:
          path: ${{ github.workspace }}
          pattern: coverage-data-*
          merge-multiple: true

      - name: Combine coverage and fail if it's <85.0%
        run: |
          python -m coverage combine
          python -m coverage html --skip-covered --skip-empty
          python -m coverage report --fail-under=85.0
          echo "## Coverage summary" >> $GITHUB_STEP_SUMMARY
          python -m coverage report --format=markdown >> $GITHUB_STEP_SUMMARY

  build:
    name: Build distribution
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: [linting, validate_migrations, tests, coverage]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"
    - name: Install pypa/build
      run: >-
        python3 -m
        pip install
        build
        --user
    - name: Build a binary wheel and a source tarball
      run: python3 -m build
    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

  publish-to-testpypi:
    name: Publish to TestPyPI
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && (contains(github.ref_name, 'a') || contains(github.ref_name, 'b') || contains(github.ref_name, 'rc'))
    needs: build
    runs-on: ubuntu-latest

    environment:
      name: testpypi
      url: https://test.pypi.org/p/django-easy-cache

    permissions:
      id-token: write

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/

  publish-to-pypi:
    name: Publish to PyPI
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, 'a') && !contains(github.ref_name, 'b') && !contains(github.ref_name, 'rc')
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/django-easy-cache
    permissions:
      id-token: write

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
